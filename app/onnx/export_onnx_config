"""
Script export YOLOv12 sang ONNX cho Medical Imaging Dataset
Tá»‘i Æ°u cho dataset cÃ³ nhiá»u kÃ­ch thÆ°á»›c áº£nh khÃ¡c nhau
Cháº¡y script nÃ y trÃªn SERVER (nÆ¡i cÃ³ YOLOv12)
"""

from ultralytics import YOLO
from pathlib import Path
import torch

# ========================= Cáº¤U HÃŒNH =========================
MODEL_PATHS = {
    "yolov12n": "/home/binhnv/results/yolov12/yolov12n/yolov12n_uit_multi_imaging_medical/weights/best.pt",
    "yolov12s": "/home/binhnv/results/yolov12/yolov12s/yolov12s_uit_multi_imaging_medical/weights/best.pt",
    "yolov12m": "/home/binhnv/results/yolov12/yolov12m/yolov12m_uit_multi_imaging_medical/weights/best.pt",
}

# Cáº¥u hÃ¬nh export - QUAN TRá»ŒNG!
EXPORT_CONFIG = {
    # 1. Dynamic input size - Há»– TRá»¢ NHIá»€U KÃCH THÆ¯á»šC áº¢NH
    # Medical imaging thÆ°á»ng cÃ³ size khÃ¡c nhau (256x256, 512x512, 640x640, v.v.)
    "dynamic": True,  # â­ QUAN TRá»ŒNG NHáº¤T - cho phÃ©p input size linh hoáº¡t
    
    # 2. Image size cho training
    # Pháº£i khá»›p vá»›i imgsz khi train (báº¡n train vá»›i 640)
    "imgsz": 640,
    
    # 3. Precision
    # FP32 (máº·c Ä‘á»‹nh) Ä‘á»ƒ Ä‘áº£m báº£o accuracy cao cho medical imaging
    # KhÃ´ng dÃ¹ng FP16 (half=True) vÃ¬ cÃ³ thá»ƒ giáº£m Ä‘á»™ chÃ­nh xÃ¡c
    "half": False,
    
    # 4. Simplify graph - giáº£m kÃ­ch thÆ°á»›c model
    "simplify": True,
    
    # 5. ONNX opset version
    # DÃ¹ng 17 Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch tá»‘t vá»›i ONNX Runtime má»›i vÃ  cÅ©
    "opset": 17,
    
    # 6. Batch size
    # batch=1 cho inference Ä‘Æ¡n láº», hoáº·c -1 cho dynamic batch
    "batch": 1,  # CÃ³ thá»ƒ thay báº±ng -1 náº¿u cáº§n batch Ä‘á»™ng
}

def print_model_info(model_path: str):
    """In thÃ´ng tin model trÆ°á»›c khi export"""
    print(f"\n{'='*60}")
    print(f"ğŸ“Š THÃ”NG TIN MODEL: {Path(model_path).parent.parent.name}")
    print(f"{'='*60}")
    
    model = YOLO(model_path)
    
    # Láº¥y thÃ´ng tin tá»« model
    print(f"âœ… Model path: {model_path}")
    print(f"âœ… Model type: {model.task}")
    print(f"âœ… Number of classes: {len(model.names)}")
    print(f"âœ… Class names: {model.names}")
    
    # Kiá»ƒm tra input size tá»« model
    if hasattr(model.model, 'yaml'):
        yaml_cfg = model.model.yaml
        if 'imgsz' in yaml_cfg:
            print(f"âœ… Training image size: {yaml_cfg['imgsz']}")
    
    return model

def export_model_to_onnx(model_path: str, model_name: str):
    """
    Export model sang ONNX vá»›i cáº¥u hÃ¬nh tá»‘i Æ°u
    
    Args:
        model_path: ÄÆ°á»ng dáº«n Ä‘áº¿n file .pt
        model_name: TÃªn model (yolov12n, yolov12s, yolov12m)
    """
    print(f"\n{'='*60}")
    print(f"ğŸš€ Báº®T Äáº¦U EXPORT: {model_name}")
    print(f"{'='*60}")
    
    # Load model
    model = print_model_info(model_path)
    
    # Output path
    output_dir = Path(model_path).parent
    onnx_path = output_dir / f"{model_name}.onnx"
    
    print(f"\nğŸ“ Cáº¤U HÃŒNH EXPORT:")
    for key, value in EXPORT_CONFIG.items():
        print(f"   {key}: {value}")
    
    # Export
    print(f"\nâ³ Äang export... (cÃ³ thá»ƒ máº¥t vÃ i phÃºt)")
    try:
        exported_path = model.export(
            format="onnx",
            **EXPORT_CONFIG
        )
        
        print(f"\nâœ… EXPORT THÃ€NH CÃ”NG!")
        print(f"   ğŸ“ File ONNX: {exported_path}")
        print(f"   ğŸ“Š KÃ­ch thÆ°á»›c: {Path(exported_path).stat().st_size / (1024*1024):.2f} MB")
        
        return exported_path
        
    except Exception as e:
        print(f"\nâŒ Lá»–I KHI EXPORT: {str(e)}")
        import traceback
        traceback.print_exc()
        return None

def verify_onnx_model(onnx_path: str):
    """
    Kiá»ƒm tra ONNX model sau khi export
    """
    print(f"\n{'='*60}")
    print(f"ğŸ” KIá»‚M TRA ONNX MODEL")
    print(f"{'='*60}")
    
    try:
        import onnx
        import onnxruntime as ort
        
        # 1. Kiá»ƒm tra vá»›i ONNX
        print("\n1ï¸âƒ£ Kiá»ƒm tra cáº¥u trÃºc ONNX...")
        onnx_model = onnx.load(onnx_path)
        onnx.checker.check_model(onnx_model)
        print("   âœ… Cáº¥u trÃºc ONNX há»£p lá»‡")
        
        # 2. Kiá»ƒm tra input shape
        print("\n2ï¸âƒ£ Kiá»ƒm tra input/output shapes...")
        graph = onnx_model.graph
        
        # Input
        for input_tensor in graph.input:
            shape = [dim.dim_value if dim.dim_value > 0 else "dynamic" 
                    for dim in input_tensor.type.tensor_type.shape.dim]
            print(f"   ğŸ“¥ Input: {input_tensor.name}")
            print(f"      Shape: {shape}")
            print(f"      Type: {input_tensor.type.tensor_type.elem_type}")
        
        # Output
        for output_tensor in graph.output:
            shape = [dim.dim_value if dim.dim_value > 0 else "dynamic" 
                    for dim in output_tensor.type.tensor_type.shape.dim]
            print(f"   ğŸ“¤ Output: {output_tensor.name}")
            print(f"      Shape: {shape}")
        
        # 3. Test inference vá»›i ONNX Runtime
        print("\n3ï¸âƒ£ Test inference vá»›i ONNX Runtime...")
        session = ort.InferenceSession(onnx_path, providers=['CPUExecutionProvider'])
        
        # Test vá»›i nhiá»u kÃ­ch thÆ°á»›c khÃ¡c nhau (quan trá»ng cho medical imaging!)
        test_sizes = [(640, 640), (512, 512), (256, 256), (800, 600)]
        
        for h, w in test_sizes:
            try:
                import numpy as np
                dummy_input = np.random.randn(1, 3, h, w).astype(np.float32)
                input_name = session.get_inputs()[0].name
                outputs = session.run(None, {input_name: dummy_input})
                print(f"   âœ… Size {h}x{w}: OK - Output shape: {outputs[0].shape}")
            except Exception as e:
                print(f"   âŒ Size {h}x{w}: FAILED - {str(e)}")
        
        print("\nâœ… KIá»‚M TRA HOÃ€N Táº¤T!")
        
    except ImportError as e:
        print(f"\nâš ï¸  Cáº§n cÃ i Ä‘áº·t onnx vÃ  onnxruntime Ä‘á»ƒ kiá»ƒm tra:")
        print(f"   pip install onnx onnxruntime")
    except Exception as e:
        print(f"\nâŒ Lá»–I: {str(e)}")
        import traceback
        traceback.print_exc()

def main():
    """Main function"""
    print("="*60)
    print("ğŸ¥ EXPORT YOLOV12 TO ONNX FOR MEDICAL IMAGING")
    print("="*60)
    
    print("\nğŸ“‹ Táº I SAO Cáº¤U HÃŒNH NÃ€Y PHÃ™ Há»¢P CHO MEDICAL IMAGING?")
    print("-" * 60)
    print("1. dynamic=True:")
    print("   â†’ Cho phÃ©p input nhiá»u size khÃ¡c nhau (256, 512, 640, 800...)")
    print("   â†’ Medical images thÆ°á»ng cÃ³ resolution khÃ¡c nhau")
    print("   â†’ KhÃ´ng cáº§n resize cá»©ng nháº¯c vá» 640x640")
    print()
    print("2. half=False (FP32):")
    print("   â†’ Giá»¯ Ä‘á»™ chÃ­nh xÃ¡c cao nháº¥t")
    print("   â†’ Medical imaging yÃªu cáº§u Ä‘á»™ chÃ­nh xÃ¡c cao")
    print("   â†’ KhÃ´ng hy sinh accuracy Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™")
    print()
    print("3. opset=17:")
    print("   â†’ TÆ°Æ¡ng thÃ­ch vá»›i háº§u háº¿t ONNX Runtime")
    print("   â†’ Há»— trá»£ dynamic shapes tá»‘t")
    print()
    print("4. simplify=True:")
    print("   â†’ Tá»‘i Æ°u graph, giáº£m kÃ­ch thÆ°á»›c file")
    print("   â†’ TÄƒng tá»‘c Ä‘á»™ inference")
    print("-" * 60)
    
    # Kiá»ƒm tra cÃ¡c model tá»“n táº¡i
    available_models = {name: path for name, path in MODEL_PATHS.items() 
                       if Path(path).exists()}
    
    if not available_models:
        print("\nâŒ KhÃ´ng tÃ¬m tháº¥y model nÃ o!")
        return
    
    print(f"\nâœ… TÃ¬m tháº¥y {len(available_models)} model(s)")
    
    # Export tá»«ng model
    exported_files = []
    for model_name, model_path in available_models.items():
        onnx_path = export_model_to_onnx(model_path, model_name)
        if onnx_path:
            exported_files.append(onnx_path)
            
            # Verify ONNX model
            verify_onnx_model(onnx_path)
    
    # Tá»•ng káº¿t
    print(f"\n{'='*60}")
    print(f"ğŸ‰ HOÃ€N Táº¤T!")
    print(f"{'='*60}")
    print(f"âœ… ÄÃ£ export {len(exported_files)} file ONNX:")
    for file_path in exported_files:
        print(f"   ğŸ“ {file_path}")
    
    print(f"\nğŸ“ BÆ¯á»šC TIáº¾P THEO:")
    print(f"1. Copy cÃ¡c file .onnx vá» laptop cá»§a báº¡n")
    print(f"2. DÃ¹ng script test_onnx.py Ä‘á»ƒ test trÃªn laptop")
    print(f"3. File ONNX cÃ³ thá»ƒ cháº¡y trÃªn báº¥t ká»³ platform nÃ o (Windows/Linux)")

if __name__ == "__main__":
    main()